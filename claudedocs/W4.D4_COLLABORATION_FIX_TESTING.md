# W4.D4 Collaboration Fix - Testing Guide

**Date**: 2025-10-18
**Status**: ‚úÖ FIXED - Ready for Testing
**Severity**: üî¥ CRITICAL - Multi-user collaboration was completely broken

## What Was Fixed

### Problem
Users could only see objects they created themselves, despite presence/cursors working correctly. This made real-time collaboration impossible.

### Root Cause
Two places in [canvasSlice.ts](../../src/stores/slices/canvasSlice.ts) were filtering objects by `created_by = userId`:

1. **Line 167**: Initial load query
2. **Line 610** (now 613): Realtime subscription filter

### Solution Applied
**Option A: Single Global Canvas** (immediate fix)

Removed both user filters to enable collaboration on single global canvas:

```typescript
// BEFORE (BROKEN):
.eq('created_by', userId)  // Line 167
filter: `created_by=eq.${userId}`  // Line 610

// AFTER (FIXED):
// Filters completely removed - all users see all objects
```

## Testing Requirements

### Prerequisites
- Two browser windows/tabs (or two different browsers)
- Two different user accounts
- Development server running (`pnpm dev`)

### Test Scenario 1: Initial Load Collaboration

**Steps**:
1. **User A**: Log in to account A
2. **User A**: Create 3 shapes (circle, rectangle, text)
3. **User A**: Note the object IDs/types created
4. **User B**: Log in to account B (different browser/tab)
5. **User B**: Verify can see ALL 3 of User A's shapes immediately

**Expected Result**:
- ‚úÖ User B sees all 3 shapes created by User A
- ‚úÖ Shapes are interactive (can select, move, edit)
- ‚úÖ PropertyPanel shows correct properties when User B selects User A's shapes

**Failure Indicators**:
- ‚ùå User B sees empty canvas
- ‚ùå User B only sees own shapes after creating some
- ‚ùå Console errors about missing objects

### Test Scenario 2: Realtime Sync (Create)

**Steps**:
1. **Both users**: Logged in, looking at canvas
2. **User A**: Create a new circle
3. **User B**: Observe canvas (do NOT refresh)

**Expected Result**:
- ‚úÖ User B sees circle appear in real-time (within 1-2 seconds)
- ‚úÖ Circle appears in correct position with correct properties
- ‚úÖ Console shows `INSERT` event logged

**Failure Indicators**:
- ‚ùå User B doesn't see circle until refresh
- ‚ùå Console shows no realtime events
- ‚ùå Circle appears but with wrong properties

### Test Scenario 3: Realtime Sync (Update)

**Steps**:
1. **User A**: Select existing shape
2. **User A**: Change color via PropertyPanel color picker
3. **User B**: Observe the same shape (do NOT refresh)

**Expected Result**:
- ‚úÖ User B sees color change in real-time
- ‚úÖ PropertyPanel preserves User A's selection during color change
- ‚úÖ Console shows `UPDATE` event logged

**Failure Indicators**:
- ‚ùå User B doesn't see color change until refresh
- ‚ùå User A's selection is lost when clicking color picker
- ‚ùå Console shows no realtime events

### Test Scenario 4: Realtime Sync (Delete)

**Steps**:
1. **User A**: Select and delete a shape
2. **User B**: Observe canvas (do NOT refresh)

**Expected Result**:
- ‚úÖ Shape disappears from User B's canvas in real-time
- ‚úÖ Console shows `DELETE` event logged
- ‚úÖ No errors about missing objects

**Failure Indicators**:
- ‚ùå Shape remains visible for User B until refresh
- ‚ùå Console errors about deleting non-existent objects
- ‚ùå Console shows no realtime events

### Test Scenario 5: Property Changes Preserve Selection

**Steps**:
1. **User A**: Create and select a circle
2. **User A**: Open PropertyPanel color picker
3. **User A**: Click inside popover to change color
4. **User A**: Verify selection still active

**Expected Result**:
- ‚úÖ Selection handles remain visible during color picker interaction
- ‚úÖ PropertyPanel continues showing object properties
- ‚úÖ Color changes apply to selected object
- ‚úÖ Console shows selection events NOT firing during property changes

**Failure Indicators**:
- ‚ùå Selection lost when clicking color picker
- ‚ùå PropertyPanel shows "No object selected"
- ‚ùå Must re-select object to continue editing

### Test Scenario 6: Concurrent Editing

**Steps**:
1. **User A**: Create 5 different shapes
2. **User B**: Verify sees all 5 shapes
3. **Both users simultaneously**: Each select and edit different shapes
4. **Observe**: Changes sync without conflicts

**Expected Result**:
- ‚úÖ Both users see each other's changes in real-time
- ‚úÖ No conflicts or lost updates
- ‚úÖ Each user's selection independent
- ‚úÖ PropertyPanel works correctly for both users

**Failure Indicators**:
- ‚ùå Updates conflict or overwrite each other
- ‚ùå Objects disappear or duplicate
- ‚ùå Console errors about concurrent modifications

## Console Verification

### Expected Console Logs

**On Initial Load** (each user):
```
üîÑ Loading canvas objects from database...
‚úÖ Loaded X canvas objects
```

**On Realtime INSERT** (other users):
```
üéØ Realtime INSERT event received
‚ûï Adding object to canvas: [object-id]
```

**On Realtime UPDATE** (other users):
```
üéØ Realtime UPDATE event received
üîÑ Updating object: [object-id]
```

**On Realtime DELETE** (other users):
```
üéØ Realtime DELETE event received
‚ûñ Removing object: [object-id]
```

### Unexpected Logs (Indicate Problems)

**Selection events during property changes**:
```
‚ùå üéØ selection:cleared (should NOT fire when clicking PropertyPanel)
```

**Missing realtime events**:
```
‚ùå No logs after other user creates/updates/deletes
```

**Filter-related errors**:
```
‚ùå "No objects found" (when other users have created objects)
```

## Database Verification

### RLS Policies (Should Be Correct)

Check Supabase Dashboard ‚Üí Database ‚Üí Policies for `canvas_objects`:

**SELECT Policy** (should be):
```sql
CREATE POLICY "Canvas objects are viewable by everyone"
  ON canvas_objects FOR SELECT
  TO authenticated
  USING (true);  -- ‚úÖ All users can view all objects
```

**INSERT/UPDATE/DELETE Policies** (should allow users to modify own objects):
```sql
-- Users can insert their own objects
USING (auth.uid() = created_by)

-- Users can update their own objects
USING (auth.uid() = created_by)

-- Users can delete their own objects
USING (auth.uid() = created_by)
```

### Query Verification

Run in Supabase SQL Editor to verify data:

```sql
-- Show all canvas objects with creator info
SELECT
  id,
  type,
  created_by,
  created_at,
  updated_at
FROM canvas_objects
ORDER BY created_at DESC
LIMIT 20;

-- Count objects by user
SELECT
  created_by,
  COUNT(*) as object_count
FROM canvas_objects
GROUP BY created_by;
```

Expected: Should see objects from MULTIPLE users (not just one).

## Rollback Plan

If collaboration fix causes issues:

1. **Revert canvasSlice.ts changes**:
```typescript
// Line 167 - Add back:
.eq('created_by', userId)

// Line 613 - Add back:
filter: `created_by=eq.${userId}`,
```

2. **Restart development server**
3. **Document issue** in new claudedocs file
4. **Consider multi-canvas architecture** (Option B from [CRITICAL_MULTI_CANVAS_ARCHITECTURE_GAP.md](./CRITICAL_MULTI_CANVAS_ARCHITECTURE_GAP.md))

## Success Criteria

‚úÖ **All 6 test scenarios pass without failures**
‚úÖ **Console logs show expected realtime events**
‚úÖ **No selection deselection bugs when editing properties**
‚úÖ **Database contains objects from multiple users**
‚úÖ **No errors in browser console or server logs**

## Next Steps After Testing

If all tests pass:
1. ‚úÖ Mark collaboration fix as verified
2. Update [MASTER_TASK_LIST.md](../../docs/MASTER_TASK_LIST.md) with multi-canvas plans for Phase III
3. Create Phase III backlog item for multi-canvas architecture
4. Document single global canvas model in architecture docs

If tests fail:
1. Document specific failure scenario
2. Check console logs for error details
3. Verify database RLS policies
4. Consider rollback if critical
5. Investigate root cause before re-attempting fix

## Architecture Notes

### Current Model: Single Global Canvas
- All users collaborate on ONE shared canvas (like Miro)
- All objects visible to all authenticated users
- RLS policies control who can modify objects
- No concept of "my canvas" vs "other canvases"

### Future Model: Multi-Canvas (Phase III)
- Users can create multiple named canvases
- Each canvas has unique `canvas_id`
- Users can share specific canvases with collaborators
- Filters change to `canvas_id=eq.X` instead of no filter
- See [CRITICAL_MULTI_CANVAS_ARCHITECTURE_GAP.md](./CRITICAL_MULTI_CANVAS_ARCHITECTURE_GAP.md) for implementation plan

## Files Modified

1. **[src/stores/slices/canvasSlice.ts](../../src/stores/slices/canvasSlice.ts)**:
   - Line 167: Removed `.eq('created_by', userId)` from initial load
   - Line 613: Removed `filter: 'created_by=eq.${userId}'` from realtime subscription
   - Added extensive comments documenting the fix

## Related Documentation

- [W4.D4_CRITICAL_SELECTION_SYNC_FIX.md](./W4.D4_CRITICAL_SELECTION_SYNC_FIX.md) - Selection deselection fixes
- [CRITICAL_MULTI_CANVAS_ARCHITECTURE_GAP.md](./CRITICAL_MULTI_CANVAS_ARCHITECTURE_GAP.md) - Architecture analysis and future plans
- [ARCHITECTURE_DATA_FLOW_ANALYSIS.md](./ARCHITECTURE_DATA_FLOW_ANALYSIS.md) - Overall architecture validation
