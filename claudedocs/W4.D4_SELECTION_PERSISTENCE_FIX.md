# W4.D4 Selection Persistence Fix

**Date**: 2025-10-18
**Issue**: Selection is lost when interacting with PropertyPanel color picker
**Root Cause**: Fabric.js deselects objects when clicking outside canvas element

## Problem Analysis

### Current Behavior
1. User selects a shape on canvas
2. Fabric.js fires `selection:created` event
3. Selection syncs to Zustand `selectedIds`
4. PropertyPanel shows with color picker
5. **User clicks color picker**
6. Fabric.js interprets this as "click outside canvas"
7. Fabric.js fires `selection:cleared` event
8. Zustand `selectedIds` is cleared
9. PropertyPanel shows "No object selected"

### Why This Happens
Fabric.js v6's default behavior:
- Listens to `mousedown` events on `document`
- If mousedown occurs outside canvas element → clears selection
- This is standard canvas editor behavior BUT not ideal for sidebars with controls

## Solution Approaches

### Option 1: Prevent Deselection on Sidebar Clicks ✅ RECOMMENDED
**Strategy**: Stop mousedown event propagation from sidebars to prevent Fabric from seeing it

**Pros**:
- Surgical fix - only affects sidebar interactions
- Preserves normal canvas click-to-deselect behavior
- No Fabric.js internals modification needed

**Implementation**:
```tsx
// In Sidebar.tsx or PropertyPanel.tsx
<div
  onMouseDown={(e) => e.stopPropagation()}
  className="sidebar-content"
>
  {/* Color picker and other controls */}
</div>
```

### Option 2: Custom Selection Management
**Strategy**: Override Fabric.js selection events with custom logic

**Pros**:
- Full control over selection behavior
- Can implement "sticky" selection

**Cons**:
- More complex
- Requires maintaining custom selection state
- May conflict with Fabric's built-in features

### Option 3: Disable Auto-Deselect Globally
**Strategy**: Configure Fabric.js to never auto-deselect

**Cons**:
- Breaks standard canvas UX (clicking empty canvas should deselect)
- Not configurable per-interaction

## Recommended Fix

### Step 1: Add Event Stop Propagation to Sidebar
Prevent mousedown events in sidebars from reaching document-level listeners:

```tsx
// src/components/layout/Sidebar.tsx
export function Sidebar({ children, isOpen, onClose }: SidebarProps) {
  return (
    <aside
      onMouseDown={(e) => {
        // Prevent Fabric.js from detecting clicks in sidebar as "outside canvas"
        e.stopPropagation();
      }}
      className={/* ... */}
    >
      {children}
    </aside>
  );
}
```

### Step 2: Verify PropertyPanel Interactions
Ensure all interactive elements in PropertyPanel work correctly:
- Color picker (RgbaColorPicker)
- Input fields
- Sliders
- Dropdowns

### Step 3: Test Edge Cases
- Click canvas empty space → should deselect
- Click sidebar controls → should NOT deselect
- Click outside app entirely → behavior undefined (acceptable)

## Architectural Assessment

### Is Our System Designed Well?

**Short Answer**: Yes, but this is a common gotcha in canvas-based editors.

**Analysis**:

✅ **Good Architecture**:
- Clean separation: Canvas Layer → State Layer → UI Layer
- Event-driven sync between Fabric.js and Zustand
- Proper use of selection events

⚠️ **Common Canvas Editor Challenge**:
- **All canvas editors face this**: Figma, Canva, Excalidraw all handle similar issues
- Fabric.js defaults prioritize standalone canvas behavior
- When embedding canvas in rich UI (sidebars, panels), need explicit event handling

**Comparison to Industry Standards**:
- **Figma**: Uses custom canvas renderer (Skia), full control over selection
- **Excalidraw**: React-based, uses `pointer-events: none` on UI overlays
- **Fabric.js apps**: Typically use event.stopPropagation() pattern (our solution)

### System Health Check

| Component | Status | Notes |
|-----------|--------|-------|
| Canvas Layer (Fabric.js) | ✅ Good | Proper object management |
| State Layer (Zustand) | ✅ Good | Selection syncs correctly |
| Sync Layer (CanvasSyncManager) | ✅ Good | Event handlers working |
| UI Layer (React) | ⚠️ Fixable | Need event propagation control |
| Overall Architecture | ✅ Solid | Standard Fabric.js integration pattern |

**Verdict**: This is NOT a systemic design flaw. It's a **known interaction pattern** that requires explicit handling in any canvas+sidebar application.

## Implementation Status

- [x] Issue identified and root cause analyzed
- [x] Solution designed (stopPropagation on sidebar mousedown)
- [ ] Implementation in Sidebar.tsx
- [ ] Testing with PropertyPanel color picker
- [ ] Testing with other interactive controls
- [ ] Edge case validation

## Related Issues

This fix also improves:
- Z-index button interactions (no accidental deselection)
- Property input field interactions
- Layer panel drag-drop operations
- Any future sidebar controls

## References

- Fabric.js Issue: https://github.com/fabricjs/fabric.js/issues/4683
- Common pattern in canvas editors
- React event propagation: https://react.dev/learn/responding-to-events#stopping-propagation
