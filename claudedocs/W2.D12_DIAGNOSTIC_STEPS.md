# W2.D12 Critical Rendering Bug - Diagnostic Steps

## Status
- **Issue**: Objects added to Fabric.js canvas but not rendering visually
- **Code Changes**: Added explicit `visible: true`, `selectable: true`, `evented: true` to object creation
- **Next**: User testing required to verify fix

## Changes Made

### 1. [FabricCanvasManager.ts:270-285](../src/lib/fabric/FabricCanvasManager.ts#L270-L285)
**Fix**: Explicitly set `visible`, `selectable`, and `evented` properties
```typescript
const commonProps = {
  // ... existing properties
  visible: true,      // NEW: Ensure objects render
  selectable: true,   // NEW: Ensure objects can be selected
  evented: true,      // NEW: Ensure objects respond to events
  // ...
};
```

### 2. [useShapeCreation.ts:119-134](../src/hooks/useShapeCreation.ts#L119-L134)
**Enhancement**: Added comprehensive diagnostic logging
- Logs canvas dimensions
- Logs object position and size
- Logs created Fabric object properties (visible, opacity, position)

## Testing Instructions

### Test 1: Basic Object Creation
1. Open the browser at `http://localhost:5173`
2. Click the **Rectangle** tool button in the sidebar
3. **Observe cursor change to crosshair** (confirms placement mode activated)
4. Click anywhere on the canvas
5. **Expected**: Blue rectangle appears at click position
6. **If fails**: Open browser console, check for errors

### Test 2: Check Console Logs
Open browser DevTools console and look for these log sequences:

#### Expected Log Sequence (Success)
```
[useShapeCreation] handleAddShape - entering placement mode for: rectangle
[Canvas] Placement mode updated: { isPlacementMode: true }
[FabricCanvasManager] Placement click detected: { canvasX: 150, canvasY: 200, ... }
[Canvas] Handling placement click: { x: 150, y: 200, ... }
[useShapeCreation] Creating object at canvas position: { type: 'rectangle', x: 150, y: 200, ... }
[useShapeCreation] Canvas dimensions: { width: 1200, height: 800 }
[useShapeCreation] Object will be at: { x: 150, y: 200, width: 200, height: 150 }
[FabricCanvasManager] Adding object to canvas: { id: '...', type: 'rectangle', ... }
[FabricCanvasManager] fabricObject details: { type: 'Rect', left: 150, top: 200, visible: true, ... }
[FabricCanvasManager] Object added, new count: 1
[useShapeCreation] Fabric object created: { visible: true, opacity: 1, left: 150, top: 200 }
```

#### Diagnostic Flags to Check
- ✅ `isPlacementMode: true` - Placement mode activated
- ✅ `visible: true` - Object is visible
- ✅ `opacity: 1` - Object is fully opaque
- ✅ `canvasX, canvasY` within canvas dimensions - Object positioned correctly
- ✅ `new count: 1` - Object added to canvas

### Test 3: Manual Render Check (If Objects Still Invisible)
If objects are added (console confirms) but still not visible:

1. Open browser console
2. Run these commands:
```javascript
// Check canvas instance
const canvas = window.__fabricCanvas;
console.log('Canvas:', canvas);
console.log('Objects:', canvas.getObjects());

// Check first object properties
const obj = canvas.getObjects()[0];
console.log('First object:', {
  type: obj.type,
  visible: obj.visible,
  opacity: obj.opacity,
  left: obj.left,
  top: obj.top,
  fill: obj.fill,
  width: obj.width,
  height: obj.height,
});

// Force manual render
canvas.renderAll();
console.log('Forced render - check if object appeared');
```

### Test 4: Check Canvas Element
Verify canvas element is properly initialized:

```javascript
const canvasEl = document.getElementById('fabric-canvas');
console.log('Canvas element:', {
  id: canvasEl.id,
  width: canvasEl.width,
  height: canvasEl.height,
  clientWidth: canvasEl.clientWidth,
  clientHeight: canvasEl.clientHeight,
});

// Check for Fabric's generated canvas elements
const lowerCanvas = document.querySelector('.lower-canvas');
const upperCanvas = document.querySelector('.upper-canvas');
console.log('Lower canvas:', lowerCanvas);
console.log('Upper canvas:', upperCanvas);
```

## Potential Issues and Solutions

### Issue 1: Objects Still Invisible
**Symptom**: Console shows `visible: true` but objects don't appear

**Possible Causes**:
1. Canvas viewport transform is wrong
2. Canvas dimensions are 0x0
3. Objects positioned outside viewport
4. Canvas rendering context not initialized

**Debug**:
```javascript
const canvas = window.__fabricCanvas;
console.log('Viewport transform:', canvas.viewportTransform);
// Should be [1, 0, 0, 1, 0, 0] for identity (no zoom/pan)

console.log('Canvas size:', { width: canvas.width, height: canvas.height });
// Should match container size, not 0x0
```

### Issue 2: Canvas Not Initialized
**Symptom**: `window.__fabricCanvas` is undefined

**Possible Causes**:
1. FabricCanvasManager initialization failed
2. Canvas element not mounted before initialization
3. useCanvasSync hook not running

**Debug**:
- Check for errors in console during component mount
- Verify user is logged in (canvas initializes after auth)
- Check Network tab for Supabase connection issues

### Issue 3: Click Not Detected
**Symptom**: Cursor changes to crosshair but clicking does nothing

**Possible Causes**:
1. Mouse event handler not registered
2. Event propagation blocked
3. Canvas element z-index issue

**Debug**:
```javascript
// Check if placement mode is active
usePaperboxStore.getState().isPlacementMode; // Should be true

// Check event listeners
const canvas = window.__fabricCanvas;
console.log('Canvas event listeners:', canvas.__eventListeners);
```

## Success Criteria

✅ **Click-to-place works**: Clicking canvas after tool selection creates object at cursor
✅ **Object renders immediately**: Shape appears visibly on canvas
✅ **Object is selectable**: Can click and select the created object
✅ **Console logs clean**: No errors, all diagnostic logs show expected values
✅ **Multiple shapes work**: Can create rectangles, circles, and text

## Next Steps After Testing

### If Fix Works
1. Remove excessive debug logging (keep W2.D12 markers)
2. Update [MASTER_TASK_LIST.md](../docs/MASTER_TASK_LIST.md) to mark W2.D12 complete
3. Proceed with Week 2 integration testing
4. Implement tool hierarchy architecture (Option A)

### If Fix Fails
1. Share full console log output
2. Run [W2.D12_DEBUG_SCRIPT.md](./W2.D12_DEBUG_SCRIPT.md) commands
3. Compare with W2.D12_BREAKTHROUGH.md working test
4. Investigate deeper (viewport, rendering context, React mounting)

## Related Files
- [FabricCanvasManager.ts](../src/lib/fabric/FabricCanvasManager.ts) - Object creation and rendering
- [useShapeCreation.ts](../src/hooks/useShapeCreation.ts) - Click-to-place implementation
- [toolsSlice.ts](../src/stores/slices/toolsSlice.ts) - Placement mode state
- [Canvas.tsx](../src/components/canvas/Canvas.tsx) - Event handler wiring
- [W2.D12_BREAKTHROUGH.md](./W2.D12_BREAKTHROUGH.md) - Working minimal test proof
- [W2.D12_DEBUG_SCRIPT.md](./W2.D12_DEBUG_SCRIPT.md) - Comprehensive debug commands
