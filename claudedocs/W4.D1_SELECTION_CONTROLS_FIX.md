# W4.D1 Selection Controls Fix

**Date**: 2025-10-17
**Status**: ✅ Complete
**Files Modified**: `src/lib/fabric/FabricCanvasManager.ts`

## Problem Description

After fixing click-to-place and viewport persistence issues, a new issue emerged where selection controls (resize corners, rotation handle) would visually detach from selected shapes after pan/zoom operations.

### Observed Behavior
- User creates shape with click-to-place ✅
- User selects shape - controls appear correctly ✅
- User scrolls/pans viewport - **controls remain in old position** ❌
- User interacts with shape (rotate/resize) - controls snap back to correct position ✅

### User Report
> "After a shape is placed and the user scrolls, the shape controller (such as the things that you use to change the size or the rotation of it) are not attached to the image."
>
> "If I try to rotate it or move it or change the size of it, then the controls goes back and attaches back to the shape."

## Root Cause

**Fabric.js v6 Behavior**: The `requestRenderAll()` method does not automatically recalculate object control positions after viewport transform operations (pan/zoom).

**Technical Details**:
- Control positions are calculated relative to viewport coordinates
- When viewport transforms change (via `viewportTransform` matrix), controls need explicit recalculation
- User interaction triggers re-render which recalculates controls (explaining the "snap back" behavior)
- This is a documented Fabric.js v6 pattern, not an architectural issue

## Solution

Call `activeObject.setCoords()` after every viewport transform operation to force control position recalculation.

### Pattern Applied

```typescript
// After viewport transform (pan or zoom)
const activeObject = this.canvas.getActiveObject();
if (activeObject) {
  activeObject.setCoords(); // Recalculate control positions
}
this.canvas.requestRenderAll();
```

### Viewport Operations Fixed

1. **Scroll Pan** (Mouse wheel without modifiers)
   - Location: `FabricCanvasManager.ts` lines 1024-1029
   - Triggered by: Mouse wheel events without Cmd/Ctrl

2. **Scroll Zoom** (Cmd/Ctrl + Mouse wheel)
   - Location: `FabricCanvasManager.ts` lines 1071-1075
   - Triggered by: Mouse wheel with Cmd/Ctrl modifier

3. **Spacebar Pan** (Spacebar + Mouse drag)
   - Location: `FabricCanvasManager.ts` lines 900-905
   - Triggered by: Spacebar held + mouse drag

## Implementation

### Code Changes

**File**: `src/lib/fabric/FabricCanvasManager.ts`

#### Scroll Pan Handler (Lines 1024-1029)
```typescript
vpt[4] = newPanX;
vpt[5] = newPanY;

// W4.D1 FIX: Update selection controls after viewport change
const activeObject = this.canvas.getActiveObject();
if (activeObject) {
  activeObject.setCoords(); // Recalculate control positions
}

this.canvas.requestRenderAll();
```

#### Scroll Zoom Handler (Lines 1071-1075)
```typescript
// Zoom to cursor position
this.canvas.zoomToPoint(
  new Point(pointer.x, pointer.y),
  newZoom
);

// W4.D1 FIX: Update selection controls after zoom
const activeObject = this.canvas.getActiveObject();
if (activeObject) {
  activeObject.setCoords(); // Recalculate control positions
}

this.canvas.requestRenderAll();
```

#### Spacebar Pan Handler (Lines 900-905)
```typescript
vpt[4] = newPanX;
vpt[5] = newPanY;

// W4.D1 FIX: Update selection controls after spacebar pan
const activeObject = this.canvas.getActiveObject();
if (activeObject) {
  activeObject.setCoords(); // Recalculate control positions
}

this.canvas.requestRenderAll(); // Triggers recalculation
```

## Testing

### Manual Test Scenarios

1. **Create and Pan**
   - ✅ Create rectangle with click-to-place
   - ✅ Select rectangle (controls appear)
   - ✅ Scroll to pan viewport
   - ✅ **Expected**: Controls remain attached to shape

2. **Create and Zoom**
   - ✅ Create circle with click-to-place
   - ✅ Select circle (controls appear)
   - ✅ Cmd/Ctrl + scroll to zoom
   - ✅ **Expected**: Controls scale and remain attached

3. **Create and Spacebar Pan**
   - ✅ Create text object with click-to-place
   - ✅ Select text (controls appear)
   - ✅ Hold spacebar + drag to pan
   - ✅ **Expected**: Controls follow shape during pan

### Verification Steps
```bash
# TypeScript compilation
pnpm tsc --noEmit  # ✅ Passes

# Run dev server
pnpm dev

# Manual testing:
# 1. Create shape (click Rectangle tool, click canvas)
# 2. Select shape (click it)
# 3. Scroll canvas (controls should stay attached)
# 4. Zoom in/out (Cmd+scroll) (controls should stay attached)
# 5. Spacebar pan (spacebar+drag) (controls should stay attached)
```

## Related Issues

### Related Fixes
- [W4.D1_CLICK_TO_PLACE_FIX.md](./W4.D1_CLICK_TO_PLACE_FIX.md) - Initial click-to-place implementation
- [W4.D1_VIEWPORT_PERSISTENCE_DISABLED.md](./W4.D1_VIEWPORT_PERSISTENCE_DISABLED.md) - Viewport persistence root cause fix

### Known Fabric.js v6 Patterns
This fix follows the documented Fabric.js v6 pattern for maintaining control positions during viewport transforms. Similar patterns are used in:
- Group transformations
- Object scaling with viewport zoom
- Multi-object selection after pan/zoom

## Future Considerations

### Performance
- `setCoords()` is lightweight (only recalculates if object is active)
- No noticeable performance impact during testing
- Consider batching if multiple objects selected (future group selection feature)

### Edge Cases to Monitor
- Multiple selected objects (when group selection implemented)
- Nested groups with viewport transforms
- High-frequency pan/zoom operations (e.g., trackpad gestures)

### Alternative Approaches Considered
1. **Auto-update in Fabric.js**: Would require forking library - rejected
2. **requestRenderAll with force flag**: Not available in Fabric.js v6 API
3. **Custom event listener**: More complex, same result as current fix
4. **React useEffect watcher**: Would miss Fabric.js native events

## Conclusion

✅ **Fix Complete**: Selection controls now remain properly attached during all pan/zoom operations.

✅ **No Architectural Changes**: This is a standard Fabric.js v6 pattern, not a fundamental design issue.

✅ **All Viewport Operations Covered**: Scroll pan, scroll zoom, and spacebar pan all include `setCoords()` fix.

✅ **TypeScript Compilation**: Passes without errors.

**Next Steps**: Proceed with W4.D2 Property Panels implementation.
