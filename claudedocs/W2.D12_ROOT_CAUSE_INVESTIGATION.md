# W2.D12 Root Cause Investigation - Fabric.js Rendering Failure

**Date**: 2025-10-17
**Status**: CRITICAL BUG - Objects Not Rendering
**Investigation Time**: 4+ hours

## Executive Summary

After extensive investigation including v5‚Üív6 migration fixes, canvas element testing, and DOM inspection, we've confirmed that Fabric.js v6 objects are being created and added to the canvas but are **NOT rendering visually**.

## Key Findings

### ‚úÖ What Works
1. **Canvas Element**: Manual `ctx.fillRect()` draws successfully (red rectangle visible)
2. **Canvas Context**: `CanvasRenderingContext2D` is functional
3. **Object Creation**: Fabric.js Rect objects are created with correct properties
4. **Object Addition**: `canvas.add()` succeeds, object count increments (0‚Üí1‚Üí2)
5. **v6 Imports**: Named imports (`import { Canvas, Rect } from 'fabric'`) are correct
6. **Database Sync**: Objects persist to Supabase successfully (200 OK responses)

### ‚ùå What Doesn't Work
1. **Visual Rendering**: Canvas remains blank, no objects visible
2. **`__fabric` Attachment**: Canvas instance NOT attaching to DOM element
3. **`lowerCanvasEl` Property**: Logged as `undefined` instead of canvas element
4. **Constructor Name**: Shows `In` (minified) instead of `Canvas`

## Evidence Timeline

### Test 1: Minimal HTML Test (Working)
```html
<!-- test-fabric-minimal.html -->
<script src="https://cdn.jsdelivr.net/npm/fabric@6.7.1/dist/index.min.js"></script>
<script>
  const canvas = new fabric.Canvas('c');  // v5 pattern
  const rect = new fabric.Rect({...});
  canvas.add(rect);  // ‚úÖ RENDERS SUCCESSFULLY
</script>
```

**Result**: Objects render in standalone HTML file using CDN version.

### Test 2: React Integration (Failing)
```typescript
// Our code - v6 pattern
import { Canvas, Rect } from 'fabric';
this.canvas = new Canvas(element, {...});
const rect = new Rect({...});
this.canvas.add(rect);  // ‚ùå ADDED BUT NOT VISIBLE
```

**Console Output**:
```
[FabricCanvasManager] Canvas created: undefined
[FabricCanvasManager] Canvas type: In
[FabricCanvasManager] Canvas element: undefined
[FabricCanvasManager] Object added, new count: 2
```

### Test 3: Manual Canvas Drawing (Working)
```javascript
const ctx = lowerCanvas.getContext('2d');
ctx.fillStyle = 'red';
ctx.fillRect(50, 50, 100, 100);  // ‚úÖ VISIBLE
```

**Result**: Canvas context works, rendering works, but only when bypassing Fabric.js.

### Test 4: DOM Inspection
```javascript
{
  fabricAttached: false,           // ‚ùå __fabric property missing
  fabricInstance: "none",
  lowerCanvasExists: true,
  upperCanvasExists: true,
  canvasWidth: 1274,              // HiDPI scaling (2x)
  clientWidth: 637
}
```

## Package Configuration Analysis

### package.json Exports (Fabric.js v6.7.1)
```json
{
  "module": "./dist/index.mjs",           // Non-minified
  "exports": {
    ".": {
      "import": "./dist/index.min.mjs",   // üî¥ FORCES MINIFIED
      "require": "./dist/index.min.js"
    }
  }
}
```

**Key Issue**: The `exports` field forces minified builds for ESM imports, even though `module` points to non-minified.

### Vite Resolution
```typescript
// Current vite.config.ts
resolve: {
  alias: {
    '@': path.resolve(__dirname, './src'),
    // NO fabric alias - using package.json defaults
  },
}
```

**Result**: Vite uses `exports.import` ‚Üí `index.min.mjs` ‚Üí minified build

## Import Pattern Analysis

### Standalone HTML (‚úÖ Works)
```html
<script src="https://cdn.jsdelivr.net/npm/fabric@6.7.1/dist/index.min.js"></script>
<script>
  const canvas = new fabric.Canvas('c');  // v5 namespace pattern
</script>
```

### Our React App (‚ùå Fails)
```typescript
import { Canvas } from 'fabric';  // v6 named import
const canvas = new Canvas(element, options);
```

## Hypotheses Tested

### ‚ùå Hypothesis 1: Wrong Import Pattern
- **Tested**: Changed from `import * as fabric` to `import { Canvas }`
- **Result**: No change - still not rendering
- **Conclusion**: v6 imports are correct but insufficient

### ‚ùå Hypothesis 2: Minification Breaks Constructor
- **Tested**: Forced non-minified build with Vite alias
- **Result**: User rejected as "hacky" workaround
- **Conclusion**: Minification correlation but not root cause

### ‚ùå Hypothesis 3: Canvas Element ID Missing
- **Tested**: Verified `id="fabric-canvas"` exists
- **Result**: Element has ID, passed correctly
- **Conclusion**: Not the issue

### ‚ùå Hypothesis 4: Viewport Transform Issue
- **Tested**: Checked CSS transforms, object coordinates
- **Result**: No transforms, objects at visible coordinates
- **Conclusion**: Not a viewport issue

### ‚ö†Ô∏è Hypothesis 5: Constructor Failing Silently
- **Evidence**: `canvas.lowerCanvasEl === undefined`
- **Evidence**: `__fabric` property not attaching
- **Evidence**: Constructor name shows `In` (mangled)
- **Status**: **LIKELY ROOT CAUSE**

## Critical Difference: CDN vs NPM

### CDN Version (Working)
- **File**: `https://cdn.jsdelivr.net/npm/fabric@6.7.1/dist/index.min.js`
- **Format**: UMD bundle with `fabric` namespace
- **Usage**: `new fabric.Canvas()`
- **Result**: ‚úÖ Works

### NPM Version (Failing)
- **File**: `node_modules/fabric/dist/index.min.mjs`
- **Format**: ES Module with named exports
- **Usage**: `import { Canvas } from 'fabric'; new Canvas()`
- **Result**: ‚ùå Doesn't render

## Next Investigation Steps

### Priority 1: Verify UMD vs ESM Difference
1. Test if importing the UMD bundle works in React
2. Compare Canvas constructor behavior between builds
3. Check if there's a React-specific integration issue

### Priority 2: Deep Dive into Constructor
1. Add try/catch around `new Canvas()`
2. Log every property of created Canvas instance
3. Compare working vs broken instance structure

### Priority 3: Check Fabric.js v6 + React Examples
1. Search GitHub for working Fabric.js v6 + React examples
2. Compare their setup to ours
3. Identify any missing configuration

### Priority 4: Check for Known Issues
1. Search Fabric.js GitHub issues for React integration problems
2. Check if v6 has specific React requirements
3. Look for breaking changes in v6 that affect React

## Files Modified During Investigation

1. `vite.config.ts` - Added/removed Vite alias (reverted)
2. `FabricCanvasManager.ts` - Changed to v6 imports
3. `Canvas.tsx` - Added explicit canvas dimensions
4. `test-fabric-minimal.html` - Created standalone test

## User Feedback

> "it seems kind of hacky to have the unminified version. Is this common to do? Can you research how other projects similar to our clone of figma are solving this problem? Is it our architecture? We should be fixing things at the root level."

**User is correct**: The Vite alias workaround is not a root cause fix. We need to understand WHY the ES module version doesn't work with React.

## Research Findings

### Excalidraw
- **Library**: RoughJS (custom canvas renderer)
- **NOT using Fabric.js**

### tldraw
- **Library**: Custom canvas SDK
- **NOT using Fabric.js**

### Figma Clones on GitHub
- **Multiple projects using Fabric.js v6 successfully**
- **Pattern**: All use named imports like our approach
- **Difference**: Need to investigate their exact setup

## Conclusion

We have a **working import pattern** (v6 named imports) but the Canvas instance is not properly initializing. The `lowerCanvasEl` property is undefined, and the `__fabric` DOM attachment is failing. This suggests the Canvas constructor is either:

1. Receiving wrong parameters
2. Failing silently during initialization
3. Having compatibility issues with React/Vite
4. Requiring additional configuration for React environments

**Status**: Investigation ongoing - need to test UMD vs ESM and examine Canvas initialization more deeply.
