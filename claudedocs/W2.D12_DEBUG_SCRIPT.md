# W2.D12 Canvas Rendering Debug Script

## Critical Issue
Objects are being added to Fabric.js canvas (console confirms) but not rendering visually.

## Browser Console Debug Commands

Run these commands in the browser console to diagnose the rendering issue:

### 1. Check Canvas Instance
```javascript
// Access the globally exposed Fabric canvas
const canvas = window.__fabricCanvas;
console.log('Canvas instance:', canvas);
console.log('Canvas dimensions:', canvas?.width, 'x', canvas?.height);
console.log('Canvas element:', canvas?.lowerCanvasEl);
console.log('Canvas upper element:', canvas?.upperCanvasEl);
```

### 2. Check Canvas Configuration
```javascript
const canvas = window.__fabricCanvas;
console.log('Canvas config:', {
  renderOnAddRemove: canvas?.renderOnAddRemove,
  skipOffscreen: canvas?.skipOffscreen,
  enableRetinaScaling: canvas?.enableRetinaScaling,
  viewportTransform: canvas?.viewportTransform,
});
```

### 3. Check Objects in Canvas
```javascript
const canvas = window.__fabricCanvas;
const objects = canvas?.getObjects();
console.log('Objects count:', objects?.length);
console.log('Objects details:', objects?.map(obj => ({
  type: obj.type,
  left: obj.left,
  top: obj.top,
  width: obj.width,
  height: obj.height,
  fill: obj.fill,
  visible: obj.visible,
  opacity: obj.opacity,
  scaleX: obj.scaleX,
  scaleY: obj.scaleY,
})));
```

### 4. Force Manual Render
```javascript
const canvas = window.__fabricCanvas;
canvas?.renderAll();
console.log('Manual render triggered');
```

### 5. Check Canvas Element Dimensions
```javascript
const canvasEl = document.getElementById('fabric-canvas');
console.log('Canvas element:', {
  clientWidth: canvasEl?.clientWidth,
  clientHeight: canvasEl?.clientHeight,
  width: canvasEl?.width,
  height: canvasEl?.height,
  style: canvasEl?.style.cssText,
});

// Check Fabric's canvas elements
const lowerCanvas = document.querySelector('.lower-canvas');
const upperCanvas = document.querySelector('.upper-canvas');
console.log('Fabric lower canvas:', lowerCanvas);
console.log('Fabric upper canvas:', upperCanvas);
```

### 6. Create Test Object Manually
```javascript
// Test creating a simple visible object
const canvas = window.__fabricCanvas;
const { Rect } = await import('/node_modules/.vite/deps/fabric.js');

const testRect = new Rect({
  left: 100,
  top: 100,
  width: 200,
  height: 150,
  fill: '#FF0000', // Bright red for visibility
  stroke: '#000000',
  strokeWidth: 2,
});

canvas.add(testRect);
canvas.renderAll();
console.log('Test rectangle added - should be visible at (100, 100)');
```

### 7. Check for Canvas Overlay Issues
```javascript
// Check if anything is covering the canvas
const canvasContainer = document.querySelector('.relative.flex-1.overflow-hidden.bg-white');
const zIndexIssues = Array.from(document.querySelectorAll('*'))
  .filter(el => {
    const style = window.getComputedStyle(el);
    return parseInt(style.zIndex) > 10;
  })
  .map(el => ({
    element: el.tagName,
    class: el.className,
    zIndex: window.getComputedStyle(el).zIndex,
  }));
console.log('High z-index elements:', zIndexIssues);
```

### 8. Check Viewport Transform
```javascript
const canvas = window.__fabricCanvas;
const vt = canvas?.viewportTransform;
console.log('Viewport transform:', vt);
// Should be [1, 0, 0, 1, 0, 0] for no transformation
// Format: [scaleX, skewY, skewX, scaleY, translateX, translateY]

// Check if objects are within viewport bounds
const objects = canvas?.getObjects();
objects?.forEach(obj => {
  const coords = obj.aCoords;
  console.log(`Object ${obj.type} bounds:`, coords);
});
```

### 9. Verify Canvas Rendering Context
```javascript
const canvasEl = document.getElementById('fabric-canvas');
const ctx = canvasEl?.getContext('2d');
console.log('Canvas 2D context:', ctx);
console.log('Context exists:', !!ctx);

// Try to draw directly to canvas to verify context works
if (ctx) {
  ctx.fillStyle = 'yellow';
  ctx.fillRect(0, 0, 100, 100);
  console.log('Drew yellow square at (0,0) - should be visible');
}
```

### 10. Check Object Positioning Relative to Viewport
```javascript
const canvas = window.__fabricCanvas;
const objects = canvas?.getObjects();
const canvasWidth = canvas?.width;
const canvasHeight = canvas?.height;

objects?.forEach(obj => {
  const inBounds =
    obj.left >= 0 && obj.left < canvasWidth &&
    obj.top >= 0 && obj.top < canvasHeight;

  console.log(`Object ${obj.type}:`, {
    position: `(${obj.left}, ${obj.top})`,
    size: `${obj.width} x ${obj.height}`,
    inBounds,
    canvasSize: `${canvasWidth} x ${canvasHeight}`,
  });
});
```

## Expected vs Actual Results

### Expected Behavior
- Canvas dimensions match parent element
- Objects have `visible: true`, `opacity: 1`
- Viewport transform is identity matrix `[1, 0, 0, 1, 0, 0]`
- Objects positioned within canvas bounds
- Canvas 2D context exists and is functional
- Objects render immediately after `canvas.renderAll()`

### Symptoms to Look For
1. **Canvas not initialized**: Canvas instance is null or undefined
2. **Dimension mismatch**: Canvas dimensions are 0x0 or incorrect
3. **Objects out of bounds**: Objects positioned outside viewport
4. **Rendering disabled**: `renderOnAddRemove` is false
5. **Overlay blocking view**: High z-index elements covering canvas
6. **Invalid context**: 2D rendering context not working
7. **Transform issue**: Viewport transform scaling/translating objects off-screen

## Root Cause Hypotheses

### Hypothesis 1: Canvas Initialization Timing
The canvas element might not be fully mounted/sized before Fabric.js initializes.

**Test**: Check if canvas dimensions are set before Fabric initialization ([Canvas.tsx:36-46](../src/components/canvas/Canvas.tsx#L36-L46))

### Hypothesis 2: Rendering Context Not Ready
The 2D rendering context might not be properly initialized.

**Test**: Run script #9 to verify context exists and can draw

### Hypothesis 3: Objects Outside Viewport
Objects might be positioned outside the visible canvas area.

**Test**: Run script #10 to check object positions relative to canvas size

### Hypothesis 4: React StrictMode Double-Mounting
React StrictMode causes component to mount twice, potentially corrupting canvas state.

**Current Status**: StrictMode disabled in [main.tsx:6-8](../src/main.tsx#L6-L8)

### Hypothesis 5: Fabric.js v6 Rendering API Change
Fabric.js v6 might require different rendering approach than documented.

**Test**: Compare working minimal test (W2.D12_BREAKTHROUGH.md) with current implementation

## Next Actions

1. Run diagnostic scripts #1-3 first to establish baseline
2. If objects exist but invisible, run scripts #4-6 to test rendering
3. If manual render fails, run scripts #7-9 to check for blockers
4. Compare results with W2.D12_BREAKTHROUGH.md working test
5. Identify specific difference causing rendering failure
