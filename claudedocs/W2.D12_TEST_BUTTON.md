# W2.D12 Rendering Bug - Test Button Added

## What I Added

I've added a **yellow "TEST: Add Rect at 100,100"** button at the top of the tools sidebar. This button bypasses the placement mode entirely and directly creates a bright magenta rectangle at position (100, 100).

## Purpose

This test helps isolate whether the issue is:
1. **Fabric.js rendering** - If this button works, Fabric rendering is fine
2. **Placement mode logic** - If this button works but click-to-place doesn't, the issue is in the placement event handling
3. **Canvas initialization** - If nothing works, the canvas itself isn't initializing properly

## How to Test

### Test 1: Direct Add (Bypasses Placement Mode)
1. Open `http://localhost:5174`
2. Look for the yellow button at the top of the sidebar: "üêõ TEST: Add Rect at 100,100"
3. Click it
4. **Expected**: Bright magenta (pink/purple) rectangle appears at top-left area (position 100, 100) with black border

### Test 2: Click-to-Place (Original Feature)
1. Click the blue "Rectangle" button
2. Cursor should change to crosshair
3. Click anywhere on the canvas
4. **Expected**: Blue rectangle appears at cursor position

### Test 3: Console Diagnostics
Open browser DevTools ‚Üí Console tab and look for:

#### For Test Button (Direct Add):
```
[Canvas] TEST: Creating rectangle directly at (100, 100)
[Canvas] TEST: Calling fabricManager.addObject with: { type: 'rectangle', x: 100, y: 100, ... }
[FabricCanvasManager] Adding object to canvas: { id: '...', type: 'rectangle', ... }
[FabricCanvasManager] fabricObject details: { type: 'Rect', left: 100, top: 100, visible: true, ... }
[Canvas] TEST: Result: { visible: true, opacity: 1, fill: '#FF00FF', ... }
[Canvas] TEST: Manual renderAll() called
```

#### For Click-to-Place:
```
[useShapeCreation] handleAddShape - entering placement mode for: rectangle
[Canvas] Placement mode updated: { isPlacementMode: true }
[FabricCanvasManager] Placement click detected: { canvasX: ..., canvasY: ..., ... }
[Canvas] Handling placement click: { x: ..., y: ..., ... }
[useShapeCreation] Creating object at canvas position: { ... }
[FabricCanvasManager] fabricObject details: { type: 'Rect', visible: true, ... }
```

## What Each Result Means

### ‚úÖ Scenario 1: Test Button Works, Click-to-Place Doesn't
- **Diagnosis**: Placement mode event handling issue
- **Likely cause**: Mouse event not being captured or `getPointer()` returning wrong coordinates
- **Next step**: Debug the mouse:down event handler in FabricCanvasManager

### ‚úÖ Scenario 2: Both Work
- **Diagnosis**: Fix successful!
- **Next step**: Remove test button, mark W2.D12 complete, proceed with integration testing

### ‚ùå Scenario 3: Neither Works
- **Diagnosis**: Fundamental canvas rendering issue
- **Likely causes**:
  - Canvas not initialized (check `window.__fabricCanvas`)
  - Canvas dimensions are 0x0
  - Rendering context not ready
  - Objects rendering outside viewport
- **Next step**: Run full diagnostic from [W2.D12_DEBUG_SCRIPT.md](./W2.D12_DEBUG_SCRIPT.md)

### ‚ùå Scenario 4: Test Button Works but Objects Disappear on Reload
- **Diagnosis**: Rendering works, but Zustand/Supabase sync has issues
- **Likely cause**: Objects not persisting to database or loading incorrectly
- **Next step**: Check network tab for Supabase errors

## Console Commands for Manual Testing

If you want to test manually in browser console:

### Check Canvas State
```javascript
const canvas = window.__fabricCanvas;
console.log('Canvas:', canvas);
console.log('Canvas size:', { width: canvas?.width, height: canvas?.height });
console.log('Objects:', canvas?.getObjects());
console.log('First object:', canvas?.getObjects()[0]);
```

### Force Render
```javascript
window.__fabricCanvas?.renderAll();
```

### Create Test Object Manually
```javascript
const { Rect } = await import('/node_modules/.vite/deps/fabric.js');
const canvas = window.__fabricCanvas;

const testRect = new Rect({
  left: 200,
  top: 200,
  width: 150,
  height: 100,
  fill: '#00FF00', // Bright green
  stroke: '#000000',
  strokeWidth: 2,
  visible: true,
  selectable: true,
  evented: true,
});

canvas.add(testRect);
canvas.renderAll();
console.log('Green test rect added at (200, 200)');
```

## Is This Related to Tool Architecture?

**NO**. This rendering bug exists in the current code before any tool architecture changes. We haven't implemented the hierarchical tool structure (Option A) yet.

The tool buttons (Rectangle, Circle, Text) are still using the same `onAddShape` function they've always used. The issue is in the fundamental Fabric.js canvas rendering or event handling, not in the tool organization.

## What Happens After Testing

### If Test Button Works:
1. We know Fabric.js rendering is functional
2. Focus shifts to debugging the click-to-place event handler
3. Check mouse event coordinates and `getPointer()` implementation

### If Nothing Works:
1. Canvas initialization is broken
2. Need to compare with [W2.D12_BREAKTHROUGH.md](./W2.D12_BREAKTHROUGH.md) working test
3. Investigate React component mounting sequence and canvas element lifecycle

## Files Modified

1. `/Users/zeno/Projects/paperbox/src/components/canvas/Canvas.tsx` - Added `handleTestDirectAdd` function and wired to sidebar
2. `/Users/zeno/Projects/paperbox/src/components/canvas/ToolsSidebar.tsx` - Added yellow test button at top
3. `/Users/zeno/Projects/paperbox/src/lib/fabric/FabricCanvasManager.ts` - Previously added `visible: true`, `selectable: true`, `evented: true`

## Next Steps

Please run the tests above and report:
1. Which scenarios occurred (1, 2, 3, or 4)
2. Console output (copy/paste or screenshot)
3. Whether any objects appeared on canvas
4. Screenshot of canvas state

This will help pinpoint the exact issue and guide the next debugging step.
