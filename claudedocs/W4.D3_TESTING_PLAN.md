# W4.D3 Canvas Resize Fix - Testing Plan

**Date**: 2025-10-18
**Fix**: Fabric.js wrapper element dimension updates
**Dev Server**: http://localhost:5175/

## Problem Summary

White space appears when:
1. Page reloads with DevTools console open (canvas initializes at smaller viewport)
2. DevTools console closes (viewport expands)
3. Canvas doesn't expand to fill the newly available space

**Root Cause**: Fabric.js creates a wrapper div (`data-fabric="wrapper"`) with hardcoded inline style dimensions that don't automatically update when viewport changes.

## Fix Implementation

**File**: [src/lib/fabric/FabricCanvasManager.ts](../src/lib/fabric/FabricCanvasManager.ts:266-299)

```typescript
// W4.D3 CRITICAL FIX: Update Fabric.js wrapper element dimensions
const wrapper = (this.canvas as any).wrapperEl;
wrapper.style.width = `${width}px`;
wrapper.style.height = `${height}px`;
this.canvas.setDimensions({ width, height });
```

This explicitly updates both the wrapper element AND the canvas dimensions during window resize events.

## Test Scenarios

### Scenario 1: DevTools Console Resize (Primary Issue)

**Steps**:
1. Open http://localhost:5175/ in browser
2. Open DevTools console (Cmd+Option+J on Mac)
3. Reload page (Cmd+R)
4. Observe canvas initialization at reduced height
5. Close DevTools console
6. Verify canvas expands to fill viewport

**Expected Behavior**:
- ✅ Canvas initializes correctly at reduced height
- ✅ Window resize event fires when DevTools closes
- ✅ Console logs: `[FabricCanvasManager] Window resized, updating canvas:`
- ✅ Wrapper element dimensions update from ~400px to full height
- ✅ No white space visible below canvas
- ✅ Canvas fills entire viewport

**How to Verify**:
- Inspect wrapper element: Right-click canvas → Inspect → Check parent div with `data-fabric="wrapper"`
- Verify inline styles show current viewport dimensions (not hardcoded ~419px)
- Console logs should show dimension updates

### Scenario 2: Window Resize

**Steps**:
1. With page loaded, drag browser window edge to resize
2. Make window smaller
3. Make window larger
4. Observe canvas behavior

**Expected Behavior**:
- ✅ Canvas smoothly resizes with window
- ✅ Debounced updates (150ms delay)
- ✅ No flickering or rendering artifacts
- ✅ Wrapper dimensions match viewport
- ✅ No white space at any size

### Scenario 3: Canvas Object Persistence

**Steps**:
1. Create a rectangle shape on canvas
2. Create a circle shape
3. Open DevTools console
4. Reload page
5. Close DevTools console
6. Verify objects are still visible

**Expected Behavior**:
- ✅ Objects load from database after reload
- ✅ Objects render correctly at reduced size (DevTools open)
- ✅ Objects remain visible after DevTools closes
- ✅ Object positions correct relative to canvas
- ✅ No object clipping or disappearance

### Scenario 4: Multiple DevTools Toggles

**Steps**:
1. Load page normally
2. Toggle DevTools open/closed multiple times rapidly
3. Observe canvas resize behavior

**Expected Behavior**:
- ✅ Debouncing prevents excessive updates
- ✅ Canvas always ends at correct final size
- ✅ No memory leaks from resize handlers
- ✅ No console errors

## Debugging Information

### Console Logs to Watch For

**Initialization**:
```
[FabricCanvasManager] Element dimensions after CSS layout: {...}
[FabricCanvasManager] Fabric.js canvas initialized
[FabricCanvasManager] Window resize handler initialized
```

**Resize Events**:
```
[FabricCanvasManager] Window resized, updating canvas: {
  width: 1973,
  height: 854,  // Should match viewport, not 419
  prevWidth: 1973,
  prevHeight: 419,
  wrapperElement: <div>
}
[FabricCanvasManager] Canvas resize complete
```

### DOM Inspection

**Wrapper Element** (should update):
```html
<div data-fabric="wrapper" class="canvas-container"
     style="position: relative; user-select: none;
            width: 1973px; height: 854px;">
  <!-- Canvas elements -->
</div>
```

**Before Fix** (hardcoded dimensions):
```html
style="... width: 1973px; height: 419px;"  <!-- Fixed at DevTools-open size -->
```

**After Fix** (dynamic dimensions):
```html
style="... width: 1973px; height: 854px;"  <!-- Updates to match viewport -->
```

## Success Criteria

Fix is successful if:
1. ✅ No white space appears when closing DevTools after reload
2. ✅ Canvas expands smoothly to fill viewport
3. ✅ Wrapper element dimensions update correctly
4. ✅ Objects persist and render correctly
5. ✅ No console errors or warnings
6. ✅ TypeScript compilation clean
7. ✅ Performance remains smooth (debouncing works)

## Known Implementation Details

**Debouncing**: 150ms delay prevents excessive resize calculations during window drag.

**Wrapper Element Access**: Uses `(this.canvas as any).wrapperEl` because Fabric.js TypeScript types don't expose this property.

**Dimension Query Source**: Uses `container.clientWidth/clientHeight` to get post-resize dimensions.

**CSS Layout Trust**: Canvas element has `absolute inset-0, width: 100%, height: 100%` CSS that handles sizing.

## Rollback Plan

If fix doesn't work:
1. User reports white space still appears
2. Check console logs for wrapper element reference
3. Inspect DOM to verify wrapper dimensions are updating
4. Consider alternative approaches:
   - CSS-based wrapper sizing
   - Fabric.js configuration options
   - Manual wrapper element creation

## Next Steps After Testing

**If Successful**:
1. Update MASTER_TASK_LIST.md
2. Create PR for W4.D3 fixes
3. Document in session summary

**If Unsuccessful**:
1. Analyze console logs and DOM state
2. Investigate Fabric.js wrapper element behavior
3. Consider CSS-based solutions
4. User feedback on specific failure mode
