# W4.D5 Sign-Up Issue - Root Cause Analysis

**Date**: 2025-10-18
**Status**: Diagnosed - Supabase Configuration Issue
**Severity**: High - Blocks new user registration

## Issue Summary

User sign-up is failing with error: **"Error sending confirmation email"**

## Root Cause Analysis

### Primary Issue: Supabase Email Service Not Configured

**Error Evidence**:
- HTTP 500 errors from `https://snekuamfpiwauvfyecpu.supabase.co/auth/v1/signup`
- User-facing message: "Error sending confirmation email"
- Multiple failed requests to Supabase signup endpoint

**Root Cause**:
Supabase project email service is **NOT configured**. By default, Supabase requires email confirmation for new signups, but the email sending service (SMTP) is not set up on the Supabase project.

### Secondary Issue: Stale Refresh Token on Page Load

**Error Evidence**:
- `AuthApiError: Invalid Refresh Token: Refresh Token Not Found`
- HTTP 400 from `https://snekuamfpiwauvfyecpu.supabase.co/auth/v1/token?grant_type=refresh_token`
- Occurs on page load before any user interaction

**Impact**:
This is a minor UX issue - stale token from previous session stored in localStorage. Doesn't block signup but creates console noise.

## Technical Details

### Console Errors (in order of occurrence)

1. **Page Load**: Invalid refresh token error (400)
   ```
   AuthApiError: Invalid Refresh Token: Refresh Token Not Found
   at handleError2 (supabase-js)
   ```

2. **Sign-Up Submission**: Email sending failure (500)
   ```
   Failed to load resource: the server responded with a status of 500
   URL: https://snekuamfpiwauvfyecpu.supabase.co/auth/v1/signup
   ```

### Code Analysis

**SignupForm.tsx** ([src/components/auth/SignupForm.tsx:45-54](../src/components/auth/SignupForm.tsx#L45-L54)):
```typescript
try {
  await signUp(email, password);
  alert('Account created! Please check your email to confirm your account.');
  navigate('/login');
} catch (err) {
  setError(err instanceof Error ? err.message : 'Failed to sign up');
} finally {
  setIsSubmitting(false);
}
```
✅ Code is correct - properly catching and displaying errors

**useAuth.ts** ([src/hooks/useAuth.ts:45-61](../src/hooks/useAuth.ts#L45-L61)):
```typescript
const signUp = async (email: string, password: string) => {
  const displayName = email.split('@')[0];

  const { error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        display_name: displayName,
      },
    },
  });

  if (error) {
    throw error;
  }
};
```
✅ Code is correct - properly calling Supabase signup API

## Solutions

### Solution 1: Disable Email Confirmation (Quick Fix)

**Steps**:
1. Go to Supabase Dashboard: https://app.supabase.com/project/snekuamfpiwauvfyecpu
2. Navigate to: **Authentication → Email Auth**
3. **Disable** "Confirm email" option
4. Users can sign up immediately without email verification

**Pros**:
- Immediate fix, no code changes needed
- Users can start using the app right away

**Cons**:
- Less secure - no email verification
- Users can sign up with fake emails
- Not recommended for production

### Solution 2: Configure SMTP Email Service (Production Fix)

**Steps**:
1. Go to Supabase Dashboard: https://app.supabase.com/project/snekuamfpiwauvfyecpu
2. Navigate to: **Project Settings → Auth**
3. Scroll to **SMTP Settings**
4. Configure email provider (options):
   - **Resend** (recommended - API key already in .env.local: `re_LcgLKd4R_JEz1aP6CF7MsXSvX9YuhjdwX`)
   - SendGrid
   - Mailgun
   - Custom SMTP
5. Test email delivery
6. Keep "Confirm email" enabled

**Pros**:
- Secure - verifies user email ownership
- Professional - custom email templates
- Required for production deployment

**Cons**:
- Requires email service configuration
- May require paid email service account

### Solution 3: Fix Stale Refresh Token Issue

**Code Change** in [src/hooks/useAuth.ts](../src/hooks/useAuth.ts):

Add token cleanup on auth errors:
```typescript
useEffect(() => {
  const {
    data: { subscription },
  } = supabase.auth.onAuthStateChange(async (event, session) => {
    // Handle auth errors by clearing stale tokens
    if (event === 'TOKEN_REFRESHED' && !session) {
      await supabase.auth.signOut();
    }

    if (event === 'SIGNED_IN' && session) {
      setUser(session.user);
    } else if (event === 'SIGNED_OUT') {
      setUser(null);
    }
  });

  return () => subscription.unsubscribe();
}, []);
```

## Recommended Action Plan

### Immediate (Development)
1. **Disable email confirmation** in Supabase Dashboard
2. Test sign-up flow works without email verification
3. Continue development with quick fix in place

### Before Production
1. **Configure Resend SMTP** using existing API key in .env.local
2. **Re-enable email confirmation**
3. **Test complete signup flow** with email verification
4. **Add token cleanup** code to prevent stale token errors

## Testing Verification

### Test Case 1: Sign-Up Without Email Confirmation
- Navigate to `/signup`
- Fill in: `test2@example.com` / `testpass123`
- Expected: Immediate redirect to login, no email sent
- Status: ⏳ Pending Supabase configuration

### Test Case 2: Sign-Up With Email Confirmation (After SMTP Setup)
- Navigate to `/signup`
- Fill in valid email
- Expected: Success message, confirmation email received
- Status: ⏳ Pending SMTP configuration

### Test Case 3: Stale Token Cleanup (After Code Fix)
- Reload page with stale token in localStorage
- Expected: No console errors, clean page load
- Status: ⏳ Pending code implementation

## Files Examined

- ✅ [src/components/auth/SignupForm.tsx](../src/components/auth/SignupForm.tsx) - Code correct
- ✅ [src/hooks/useAuth.ts](../src/hooks/useAuth.ts) - Code correct, needs token cleanup
- ✅ [src/lib/supabase.ts](../src/lib/supabase.ts) - Configuration correct
- ✅ `.env.local` - Environment variables correct, Resend API key present

## Conclusion

**The sign-up code is working correctly.** The issue is **Supabase project email configuration**, not application code.

**User must choose**:
- **Quick development fix**: Disable email confirmation in Supabase
- **Production-ready fix**: Configure SMTP with Resend using existing API key

Both solutions require Supabase Dashboard configuration changes, not code changes.
