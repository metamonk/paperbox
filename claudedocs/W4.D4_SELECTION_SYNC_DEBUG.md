# W4.D4 Selection Sync Debug Investigation

**Date**: 2025-10-18
**Issue**: Selection not syncing from Fabric.js to Zustand
**Symptoms**:
- Circle is selected on canvas (shows selection handles)
- PropertyPanel shows "No object selected"
- Selection state not in Zustand

## Investigation Steps

### 1. Verified Event Listener Setup ✅
- [CanvasSyncManager.ts:64](../../src/lib/sync/CanvasSyncManager.ts#L64) calls `setupCanvasToStateSync()`
- [CanvasSyncManager.ts:150](../../src/lib/sync/CanvasSyncManager.ts#L150) calls `fabricManager.setupEventListeners()` with handlers
- [CanvasSyncManager.ts:166-179](../../src/lib/sync/CanvasSyncManager.ts#L166-179) handlers defined:
  - `onSelectionCreated`: extracts IDs, calls `selectObjects(ids)`
  - `onSelectionUpdated`: same as above
  - `onSelectionCleared`: calls `deselectAll()`

### 2. Verified Fabric.js Event Registration ✅
- [FabricCanvasManager.ts:306](../../src/lib/fabric/FabricCanvasManager.ts#L306) `setupEventListeners()` method
- [FabricCanvasManager.ts:337-355](../../src/lib/fabric/FabricCanvasManager.ts#L337-355) Fabric events registered:
  - `canvas.on('selection:created', ...)`
  - `canvas.on('selection:updated', ...)`
  - `canvas.on('selection:cleared', ...)`

### 3. Verified Object Properties ✅
- [FabricCanvasManager.ts:382-387](../../src/lib/fabric/FabricCanvasManager.ts#L382-387) Objects created with:
  - `selectable: true`
  - `evented: true`
  - `data: { id, type }` (required for event handlers to extract ID)

## Hypotheses

### Hypothesis 1: Events Not Firing ❓
**Theory**: Fabric.js selection events not being triggered at all

**Test**: Add console.log in FabricCanvasManager event handlers
**Location**: [FabricCanvasManager.ts:337-355](../../src/lib/fabric/FabricCanvasManager.ts#L337-355)

```typescript
this.canvas.on('selection:created', (event) => {
  console.log('[FabricCanvasManager] selection:created fired', event);
  const targets = event.selected || [];
  if (this.eventHandlers.onSelectionCreated) {
    this.eventHandlers.onSelectionCreated(targets);
  }
});
```

### Hypothesis 2: Event Handlers Not Being Called ❓
**Theory**: Events fire but handlers not being invoked

**Test**: Add console.log in CanvasSyncManager handlers
**Location**: [CanvasSyncManager.ts:166-179](../../src/lib/sync/CanvasSyncManager.ts#L166-179)

```typescript
onSelectionCreated: (targets: FabricObject[]) => {
  console.log('[CanvasSyncManager] onSelectionCreated called', targets);
  const ids = targets.map(t => (t as FabricObjectWithData).data?.id).filter(Boolean) as string[];
  console.log('[CanvasSyncManager] Extracted IDs:', ids);
  this.store.getState().selectObjects(ids);
},
```

### Hypothesis 3: Store selectObjects Not Working ❓
**Theory**: selectObjects() is called but doesn't update state

**Test**: Check canvasSlice selectObjects implementation
**Location**: Need to check src/stores/slices/canvasSlice.ts

### Hypothesis 4: Sidebar stopPropagation Blocking Events ✅ RULED OUT
**Status**: FIXED - Removed stopPropagation from Sidebar.tsx

**Previous Issue**: `event.stopPropagation()` in Sidebar was blocking ALL mouse events, including Fabric.js selection events

**Fix**: Removed stopPropagation entirely, will need alternative solution for preventing deselection on sidebar clicks

## Current Status

**Active Test**: Need to add debugging console.logs to determine which hypothesis is correct

**Next Steps**:
1. Add console.logs to both FabricCanvasManager and CanvasSyncManager event handlers
2. Click on object and check browser console
3. Determine at what point the selection sync chain breaks
4. Implement appropriate fix based on findings

## Alternative Solution Ideas

### If Events ARE Firing But selectObjects() Not Working:
- Check if Zustand store is properly initialized
- Verify selectObjects implementation in canvasSlice
- Check for any middleware interfering with state updates

### If Events NOT Firing:
- Verify Fabric.js v6 selection event names are correct
- Check if canvas configuration is preventing selection events
- Verify `setupEventListeners()` is called AFTER canvas is fully initialized

### If Handlers Not Being Called:
- Check if event handlers object is being passed correctly
- Verify closure scoping isn't causing handler loss
- Check for any middleware or wrapper breaking the event chain

## Fabric.js v6 Selection Behavior

**Default Behavior**:
- Listens to document-level mousedown events
- If mousedown detected outside canvas element → clears selection
- This is why sidebar clicks were causing deselection

**Configuration Options** (to research):
- `fireRightClick`
- `stopContextMenu`
- `targetFindTolerance`
- Other selection-related config?

**Need to Find**: Fabric.js v6 option to disable "click outside canvas clears selection" behavior
